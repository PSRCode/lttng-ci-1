metadata:
        format: Lava-Test Test Definition 1.0
        name: benchmark-raw-syscall-getpid
        description: "Perform syscall tracing benchmark of the raw syscall getpid"
params:
    JENKINS_JOBNAME: "default jobname"

install:
        deps:
                - python3-pandas
                - python3-numpy
        git-repos:
                - url: https://github.com/lttng/lttng-ci
                  destination: ci
                  branch: master
        steps:
                - export TMPDIR="/tmp"
                - ulimit -c unlimited
                - mkdir -p coredump
                - echo "$(pwd)/coredump/core.%e.%p.%h.%t" > /proc/sys/kernel/core_pattern
run:
        steps:
                - source /root/lttngvenv/activate
                - export BENCHMARK_DIR=$(mktemp --directory)/bm
                - git clone https://github.com/frdeso/syscall-bench-it.git $BENCHMARK_DIR
                - cd $BENCHMARK_DIR
                - lava-test-case build-benchmarks --shell "make"
                - lava-test-case run-benchmarks --shell "./run.sh raw-syscall-getpid sys_getpid"
                - lava-test-case-attach run-benchmarks "./results.csv"
                - cd -
                - cd ci
                - python3 ./scripts/lttng-baremetal-tests/parse-results.py $BENCHMARK_DIR/results.csv
                - mv ./processed_results.csv ../processed_results_raw_syscall_getpid.csv
                - cd -
                - tar czf coredump.tar.gz coredump
                - lava-test-case-attach run-benchmarks coredump.tar.gz
                - lava-test-case-attach run-benchmarks "./processed_results_raw_syscall_getpid.csv"
