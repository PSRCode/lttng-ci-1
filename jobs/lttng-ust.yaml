- defaults:
    name: lttng-ust
    description: |
      LTTng-UST, the Linux Trace Toolkit Next Generation Userspace Tracer, is a
      port of the low-overhead tracing capabilities of the LTTng kernel tracer
      to user-space. The library "liblttng-ust" enables tracing of
      applications and libraries.

      <p>Job is managed by Jenkins Job Builder.</p>

    project-type: freestyle

    logrotate:
        numToKeep: 2

    wrappers:
      - workspace-cleanup
      - timestamps
      - ansicolor

    scm:
      - git:
          url: git://github.com/{github_user}/{github_name}.git
          browser: githubweb
          browser-url: https://github.com/{github_user}/{github_name}
          branches:
            - origin/{version}
          basedir: src/lttng-ust

    triggers:
      - pollscm:
          cron: "@hourly"

    properties:
      - github:
          url: https://github.com/{github_user}/{github_name}


## Templates
- job-template:
    name: lttng-ust_{version}_{buildtype}
    defaults: lttng-ust

    project-type: matrix
    node: 'master' # Applies only to matrix flyweight task
    execution-strategy:
      combination-filter: |
        (build=="std") || (liburcu_version=="master")
    axes:
      - axis:
         type: slave
         name: arch
         values: '{obj:arch}'
      - axis:
         type: user-defined
         name: conf
         values: '{obj:conf}'
      - axis:
         type: user-defined
         name: liburcu_version
         values:
           !include: jobs/inc/liburcu-versions.yaml.inc
      - axis:
         type: user-defined
         name: build
         values: '{obj:build}'

    builders:
      - copyartifact:
          project: liburcu_${{liburcu_version}}_{buildtype}/arch=$arch,conf=std,build=std
          which-build: last-successful
          stable: true
          filter: 'build/**'
          target: 'deps/liburcu'
          do-not-fingerprint: true
      - shell:
         !include-raw-escape: scripts/lttng-ust/build.sh

    # TODO: Scan for open tasks
    publishers:
      - tap:
          results: 'tap/**/*.log'
          failed-tests-mark-build-as-failure: true
          todo-is-failure: false
      - warnings:
          console-log-parsers:
            - 'GNU Make + GNU C Compiler (gcc)'
          total-thresholds:
            unstable:
              total-all: 0
              total-high: 0
              total-normal: 0
              total-low: 0
      - archive:
          artifacts: 'build/**'
          allow-empty: false
      - workspace-cleanup
      - ircbot:
          strategy: new-failure-and-fixed
          matrix-notifier: only-parent
          channels:
            - name: '#lttng'

- job-template:
    name: lttng-ust_{version}_java-tests
    defaults: lttng-ust
    description: |
      Tests for LTTng-UST's Java agent. Runs the master branch of
      <a href="https://github.com/lttng/lttng-ust-java-tests">lttng-ust-java-tests</a>
      against the {version} branches of UST, lttng-tools, and Babeltrace.

      <p>Job is managed by Jenkins Job Builder.</p>

    project-type: matrix
    node: 'master' # Applies only to matrix flyweight task
    axes:
      - axis:
         type: slave
         name: arch
         values: '{obj:arch}'
      - axis:
         type: user-defined
         name: jdk_version
         values:
           - 'OpenJDK-8'
      - axis:
         type: user-defined
         name: liburcu_version
         values:
           - 'master'
      - axis:
         type: user-defined
         name: lttng_ust_version
         values:
           - 'master'
      - axis:
         type: user-defined
         name: lttng_tools_version
         values:
           - 'master'

    wrappers:
      - workspace-cleanup
      - timestamps
      - ansicolor
      - inject:
          properties-content: |
            LD_LIBRARY_PATH="${{WORKSPACE}}/deps/build/lib"
            PATH="${{WORKSPACE}}/deps/build/bin:${{PATH}}"
            LTTNG_CONSUMERD32_BIN="${{WORKSPACE}}/deps/build/lib/lttng/libexec/lttng-consumerd"
            LTTNG_CONSUMERD64_BIN="${{WORKSPACE}}/deps/build/lib/lttng/libexec/lttng-consumerd"
          script-content: |

    scm:
      - git:
          url: git://github.com/lttng/lttng-ust-java-tests.git
          browser: githubweb
          browser-url: https://github.com/lttng/lttng-ust-java-tests
          branches:
            - origin/{version}
          basedir: lttng-ust-java-tests

    triggers:
      - pollscm:
          cron: "@daily"

    properties:
      - github:
          url: https://github.com/lttng/lttng-ust-java-tests

    builders:
      - copyartifact:
          project: liburcu_${{liburcu_version}}_build/arch=${{arch}},conf=std,build=std
          which-build: last-successful
          stable: true
          filter: 'build/**'
          target: 'deps'
          do-not-fingerprint: true
      - copyartifact:
          project: lttng-ust_{version}_build/liburcu_version=${{liburcu_version}},arch=${{arch}},conf=java-agent,build=std
          which-build: last-successful
          stable: true
          filter: 'build/**'
          target: 'deps'
          do-not-fingerprint: true
      - copyartifact:
          project: lttng-tools_${{lttng_tools_version}}_build/babeltrace_version=master,liburcu_version=${{liburcu_version}},arch=${{arch}},conf=java-agent,build=std
          which-build: last-successful
          stable: true
          filter: 'build/**'
          target: 'deps'
          do-not-fingerprint: true
      - copyartifact:
          project: babeltrace_master_build/arch=${{arch}},conf=std,build=std
          which-build: last-successful
          stable: true
          filter: 'build/**'
          target: 'deps'
          do-not-fingerprint: true
      - shell: |
          #!/bin/sh -eux

          # Start the lttng-sessiond
          lttng-sessiond -d
      - maven-target:
          goals: '-version'
          maven-version: 'Maven 3.3.3'
          private-repository: true
      - maven-target:
          goals: |
            clean
            verify
          pom: 'lttng-ust-java-tests/pom.xml'
          properties:
            - maven.test.failure.ignore=true
            - common-jar-location=${{WORKSPACE}}/deps/build/share/java/lttng-ust-agent-common.jar
            - jul-jar-location=${{WORKSPACE}}/deps/build/share/java/lttng-ust-agent-jul.jar
            - log4j-jar-location=${{WORKSPACE}}/deps/build/share/java/lttng-ust-agent-log4j.jar
            - argLine=-Djava.library.path=${{WORKSPACE}}/deps/build/lib
          maven-version: 'Maven 3.3.3'
          private-repository: true
      - shell: |
          #!/bin/sh -eux

          # Kill the sessiond
          killall lttng-sessiond

    publishers:
      - junit:
          results: lttng-ust-java-tests/**/target/failsafe-reports/*.xml
      - email-ext:
          recipients: alex@voxpopuli.im
          matrix-trigger: only-parent
          failure: false
          first-failure: true
          fixed: true
      - workspace-cleanup


- job-template:
    name: lttng-ust_{version}_cppcheck
    defaults: lttng-ust

    triggers:
      - pollscm:
          cron: "@daily"

    builders:
      - shell: |
          rm -f lttng-ust-cppcheck.xml
          cppcheck --enable=all --xml --xml-version=2 $WORKSPACE 2> lttng-ust-cppcheck.xml

    publishers:
      - archive:
          artifacts: 'lttng-ust-cppcheck.xml'
          allow-empty: false
      - cppcheck:
          pattern: 'lttng-ust-cppcheck.xml'
      - email:
          recipients: 'ci-notification@lists.lttng.org'
          notify-every-unstable-build: true
          send-to-individuals: false

- job-template:
    name: lttng-ust_{version}_scan-build
    defaults: lttng-ust
    node: 'x86-64'

    triggers:
      - pollscm:
          cron: "@daily"

    builders:
      - copyartifact:
          project: liburcu_master_build/arch=x86-64,conf=std,build=std
          which-build: last-successful
          stable: true
          filter: 'build/**'
          target: 'deps/liburcu'
          do-not-fingerprint: true
      - shell:
          !include-raw-escape: scripts/lttng-ust/scan-build.sh

    publishers:
      - html-publisher:
          name: 'HTML Report'
          dir: 'scan-build-archive/'
          files: 'index.html'

- job-template:
    name: lttng-ust_{version}_coverity
    defaults: lttng-ust
    node: 'x86-64'

    triggers:
      - pollscm:
          cron: "@daily"

    wrappers:
      - workspace-cleanup
      - timestamps
      - ansicolor:
          colormap: xterm
      - credentials-binding:
          - username-password-separated:
              credential-id: lttng-ust_coverity_token
              username: COVERITY_SCAN_PROJECT_NAME
              password: COVERITY_SCAN_TOKEN

    builders:
      - copyartifact:
          project: liburcu_master_build/arch=x86-64,conf=std,build=std
          which-build: last-successful
          stable: true
          filter: 'build/**'
          target: 'deps/liburcu'
          do-not-fingerprint: true
      - shell:
          !include-raw-escape: scripts/common/coverity.sh

    publishers:
      - workspace-cleanup
      - archive:
          artifacts: 'analysis-results.tgz,cov-int/**'
          allow-empty: false

# TODO
- job-template:
    name: lttng-ust_{version}_pylint
    defaults: lttng-ust
    node: 'x86-64'

    scm: []

    triggers:
      - pollscm:
          cron: "@daily"

    builders:
       - copyartifact:
           project: lttng-ust-{version}/arch=x86-64,build=std,conf=python-agent
           which-build: last-successful
           stable: true
           filter: 'build/**'
           target: 'deps/lttng-ust'
           do-not-fingerprint: true
       - shell:
          !include-raw-escape: scripts/lttng-ust/pylint.sh

    publishers:
      - archive:
          artifacts: 'pep8.out,pylint.out'
      - violations:
          pep8:
            pattern: pep8.out
            min: 10
            max: 999
            unstable: 999
          pylint:
            pattern: pylint.out
            min: 10
            max: 999
            unstable: 999
      - email:
          recipients: 'ci-notification@lists.lttng.org'
          notify-every-unstable-build: true
          send-to-individuals: false


## Project
- project:
    name: lttng-ust
    github_user: lttng
    github_name: lttng-ust
    version:
      !include: jobs/inc/lttng-ust-versions.yaml.inc
    jobs:
      - 'lttng-ust_{version}_{buildtype}':
          buildtype: build
          arch: !!python/tuple [x86-32, x86-64]
          build: !!python/tuple [std, oot, dist]
          conf: !!python/tuple [std, java-agent, python-agent]
      - 'lttng-ust_{version}_{buildtype}':
          buildtype: portbuild
          arch: !!python/tuple [armhf, arm64, powerpc, ppc64el]
          build: !!python/tuple [std]
          conf: !!python/tuple [std, java-agent, python-agent]
      - 'lttng-ust_{version}_java-tests':
          arch: !!python/tuple [x86-32, x86-64]
      - 'lttng-ust_{version}_cppcheck'
      - 'lttng-ust_{version}_scan-build'
      - 'lttng-ust_{version}_coverity':
          version: master

